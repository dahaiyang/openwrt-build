# 京东云 ER1 (RE-CS-07) 专用编译 - 高通 IPQ60XX 平台
# 基于 VIKINGYFY/immortalwrt 高通专用源码

name: JDC-ER1-Build

on:
  workflow_dispatch:
    inputs:
      BRANCH:
        description: '源码分支'
        default: 'main'
        required: true
        type: string
      TEST:
        description: '仅生成配置文件，不编译'
        default: false
        required: true
        type: boolean

permissions: write-all

env:
  GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
  WRT_DATE: ""
  WRT_HASH: ""

jobs:
  build:
    name: JDC-ER1-IPQ60XX
    runs-on: ubuntu-latest
    
    steps:
      # ==================== 检出项目 ====================
      - name: Checkout Projects
        uses: actions/checkout@main

      # ==================== 初始化环境 ====================
      - name: Initialization Environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt -yqq purge firefox
          sudo -E apt -yqq update
          sudo -E apt -yqq full-upgrade
          sudo -E apt -yqq autoremove --purge
          sudo -E apt -yqq autoclean
          sudo -E apt -yqq clean
          sudo -E apt -yqq install dos2unix python3-netifaces libfuse-dev
          sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo -E systemctl daemon-reload
          sudo -E timedatectl set-timezone "Asia/Shanghai"
          sudo mkdir -p /mnt/build_wrt
          sudo chown $USER:$USER /mnt/build_wrt
          sudo ln -s /mnt/build_wrt $GITHUB_WORKSPACE/wrt

      # ==================== 设置变量 ====================
      - name: Set Variables
        run: |
          echo "WRT_DATE=$(TZ=UTC-8 date +"%y.%m.%d-%H.%M.%S")" >> $GITHUB_ENV
          echo "REPO_NAME=${GITHUB_REPOSITORY##*/}" >> $GITHUB_ENV

      # ==================== 克隆高通源码 ====================
      - name: Clone Qualcomm Source
        run: |
          git clone --depth=1 --single-branch --branch ${{github.event.inputs.BRANCH || 'main'}} \
            https://github.com/VIKINGYFY/immortalwrt.git ./wrt/
          cd ./wrt/
          echo "WRT_HASH=$(git log -1 --pretty=format:'%h')" >> $GITHUB_ENV
          # 移除国内镜像源
          if [ -f "./scripts/projectsmirrors.json" ]; then
            sed -i '/.cn\//d; /tencent/d; /aliyun/d' "./scripts/projectsmirrors.json"
          fi

      # ==================== 处理脚本 ====================
      - name: Check Scripts
        run: |
          find ./ -maxdepth 3 -type f -iregex ".*\.(txt|sh)$" -exec dos2unix {} \; -exec chmod +x {} \;

      # ==================== 缓存 ====================
      - name: Check Caches
        id: check-cache
        if: ${{ github.event.inputs.TEST != 'true' }}
        uses: actions/cache@main
        with:
          key: jdc-er1-${{ env.WRT_HASH }}
          restore-keys: jdc-er1-
          path: |
            ./wrt/.ccache
            ./wrt/staging_dir/host*
            ./wrt/staging_dir/tool*

      # ==================== 更新 Feeds ====================
      - name: Update Feeds
        run: |
          cd ./wrt/
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # ==================== 生成配置 ====================
      - name: Generate Config
        run: |
          cd ./wrt/
          
          # 基础平台配置 - 京东云 ER1
          cat > .config << 'EOF'
          # 目标平台 - 高通 IPQ60XX
          CONFIG_TARGET_qualcommax=y
          CONFIG_TARGET_qualcommax_ipq60xx=y
          CONFIG_TARGET_qualcommax_ipq60xx_DEVICE_jdcloud_re-cs-07=y
          CONFIG_TARGET_MULTI_PROFILE=n
          CONFIG_TARGET_PER_DEVICE_ROOTFS=y
          CONFIG_TARGET_ROOTFS_INITRAMFS=n
          CONFIG_TARGET_ROOTFS_SQUASHFS=y
          
          # 开发选项
          CONFIG_CCACHE=y
          CONFIG_DEVEL=y
          
          # ==================== 科学上网 - 精简版：只保留 Passwall ====================
          CONFIG_PACKAGE_luci-app-passwall=y
          CONFIG_PACKAGE_luci-app-passwall_INCLUDE_SingBox=y
          CONFIG_PACKAGE_luci-app-passwall_INCLUDE_Xray=y
          CONFIG_PACKAGE_sing-box=y
          CONFIG_PACKAGE_xray-core=y
          
          # [后续再加] HomeProxy - 暂不启用
          # CONFIG_PACKAGE_luci-app-homeproxy=y
          
          # [后续再加] OpenClash - 暂不启用（占用空间大）
          # CONFIG_PACKAGE_luci-app-openclash=y
          
          # [后续再加] SSR-Plus - 暂不启用（与Passwall功能重复）
          # CONFIG_PACKAGE_luci-app-ssr-plus=y
          
          # [后续再加] 其他代理组件
          # CONFIG_PACKAGE_hysteria=y
          # CONFIG_PACKAGE_naiveproxy=y
          # CONFIG_PACKAGE_tuic-client=y
          # CONFIG_PACKAGE_shadowsocks-rust-sslocal=y
          # CONFIG_PACKAGE_shadowsocks-rust-ssserver=y
          
          # ==================== 网络工具 - 精简版 ====================
          CONFIG_PACKAGE_luci-app-ddns=y
          CONFIG_PACKAGE_luci-app-upnp=y
          CONFIG_PACKAGE_luci-app-sqm=y
          CONFIG_PACKAGE_sqm-scripts-nss=y
          CONFIG_PACKAGE_luci-app-ttyd=y
          
          # [后续再加] Tailscale
          # CONFIG_PACKAGE_luci-app-tailscale=y
          
          # ==================== 系统工具 - 精简版 ====================
          CONFIG_PACKAGE_luci-app-autoreboot=y
          
          # [后续再加] 文件管理（占用较大）
          # CONFIG_PACKAGE_luci-app-filebrowser=y
          # CONFIG_PACKAGE_luci-app-samba4=y
          # CONFIG_PACKAGE_luci-app-acme=y
          # CONFIG_PACKAGE_luci-app-wol=y
          
          # ==================== 主题 - 精简版：只保留一个 ====================
          CONFIG_PACKAGE_luci-theme-argon=y
          
          # [后续再加] 
          # CONFIG_PACKAGE_luci-theme-aurora=y
          
          # ==================== 高通 NSS 优化 ====================
          CONFIG_FEED_nss_packages=n
          CONFIG_FEED_sqm_scripts_nss=n
          CONFIG_NSS_FIRMWARE_VERSION_11_4=n
          CONFIG_NSS_FIRMWARE_VERSION_12_5=y
          CONFIG_PACKAGE_kmod-usb-serial-qualcomm=y
          
          # ==================== USB 支持 - 精简版 ====================
          CONFIG_PACKAGE_kmod-usb3=y
          
          # [后续再加] USB网卡驱动（如需要）
          # CONFIG_PACKAGE_kmod-usb-net-rtl8152=y
          # CONFIG_PACKAGE_kmod-usb-storage=y
          
          # ==================== 基础组件 - 精简版 ====================
          CONFIG_PACKAGE_autocore=y
          CONFIG_PACKAGE_htop=y
          
          # [后续再加] 
          # CONFIG_PACKAGE_automount=y
          # CONFIG_PACKAGE_iperf3=y
          # CONFIG_PACKAGE_openssh-sftp-server=y
          CONFIG_PACKAGE_iperf3=y
          CONFIG_PACKAGE_openssh-sftp-server=y
          
          # ==================== Luci 基础 ====================
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-base=y
          CONFIG_LUCI_LANG_zh_Hans=y
          EOF
          
          # 修改默认设置
          sed -i 's/luci-theme-bootstrap/luci-theme-aurora/g' $(find ./feeds/luci/collections/ -type f -name "Makefile")
          sed -i 's/192\.168\.[0-9]*\.[0-9]*/192.168.10.1/g' ./package/base-files/files/bin/config_generate
          sed -i "s/hostname='.*'/hostname='JDC-ER1'/g" ./package/base-files/files/bin/config_generate
          
          make defconfig -j$(nproc)
          make clean -j$(nproc)

      # ==================== 下载包 ====================
      - name: Download Packages
        if: ${{ github.event.inputs.TEST != 'true' }}
        run: |
          cd ./wrt/
          make download -j$(nproc)

      # ==================== 编译固件 ====================
      - name: Compile Firmware
        if: ${{ github.event.inputs.TEST != 'true' }}
        timeout-minutes: 360
        run: |
          cd ./wrt/
          make -j$(nproc) || make -j1 V=s

      # ==================== 整理固件 ====================
      - name: Package Firmware
        if: ${{ github.event.inputs.TEST != 'true' }}
        run: |
          cd ./wrt/
          mkdir -p ./upload/
          
          # 复制固件（只保留 JDC-ER1 相关）
          find bin/targets/qualcommax/ipq60xx -type f \( \
            -name "*jdcloud*re-cs-07*" -o \
            -name "*qualcommax*ipq60xx*" \
          \) -exec cp {} ./upload/ \;
          
          # 复制配置文件
          cp .config ./upload/config.txt
          
          # 显示结果
          ls -lh ./upload/

      # ==================== 上传固件 ====================
      - name: Upload Firmware
        if: ${{ github.event.inputs.TEST != 'true' }}
        uses: actions/upload-artifact@main
        with:
          name: JDC-ER1-${{env.WRT_DATE}}
          path: ./wrt/upload/*
          retention-days: 7

      # ==================== 发布 Release ====================
      - name: Release Firmware
        if: ${{ github.event.inputs.TEST != 'true' }}
        uses: softprops/action-gh-release@master
        with:
          tag_name: JDC-ER1-${{env.WRT_DATE}}
          name: JDC-ER1 ${{env.WRT_DATE}}
          files: ./wrt/upload/*
          body: |
            ## 京东云 ER1 (RE-CS-07) 专用固件
            
            **设备**: 京东云 ER1 (RE-CS-07)  
            **平台**: 高通 IPQ60XX  
            **源码**: VIKINGYFY/immortalwrt  
            **分支**: ${{github.event.inputs.BRANCH || 'main'}}  
            **提交**: ${{env.WRT_HASH}}  
            
            **默认配置**:
            - IP: 192.168.10.1
            - 主机名: JDC-ER1
            - 主题: Aurora
            
            **包含插件**:
            - HomeProxy / Passwall / OpenClash / SSR-Plus
            - SQM NSS 硬件加速
            - Tailscale / Samba4 / DDNS
            - TTYD / Filebrowser
            
            **注意**: 此固件专用于 JDC-ER1，请勿刷入其他设备！

      # ==================== 仅测试配置 ====================
      - name: Test Config Only
        if: ${{ github.event.inputs.TEST == 'true' }}
        run: |
          cd ./wrt/
          echo "===== 设备配置 ====="
          cat .config | grep "CONFIG_TARGET.*DEVICE"
          echo "===== 科学上网插件 ====="
          cat .config | grep -E "(homeproxy|passwall|openclash|sing-box)"
